#!/usr/bin/env ruby
require 'trollop'
require 'bumpy'

opts = Trollop::options do
  version "bumpy #{Bumpy::VERSION} by Hendrik Mans"

  opt :dryrun, "Dry run (no writing or committing)"
  opt :no_git, "Don't automatically create git commit"
end

EXPR = %r{VERSION = ['"](.+)['"]}
opts[:new_version] = ARGV.shift


Dir['./lib/**/version.rb'].each do |name|
  contents = File.read(name)
  if contents =~ EXPR
    opts[:new_version] ||= begin
      parts = $1.split('.')
      parts[-1] = parts[-1].to_i + 1
      parts.join '.'
    end

    puts "Bumping version number found in #{name} to #{opts[:new_version]}"
    contents.sub!(EXPR, "VERSION = \"#{opts[:new_version]}\"")

    unless opts[:dryrun]
      File.write(name, contents)

      # create git commit
      if File.exists?('./.git') && !opts[:no_git]
        puts "Creating git commit"
        system "git add #{name} && git commit -m 'Bump version to #{opts[:new_version]}'"
      end
    end

    break
  end

  puts "No version file found. :("
end
